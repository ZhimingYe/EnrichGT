
#' @importFrom tinytable tt style_tt group_tt
#' @importFrom RColorBrewer brewer.pal
#' @importFrom scales col2hcl
#' @importFrom scales col_numeric
gt_tt <- function(x, ClusterNum, objname, objname2 = NULL, TYPE, ...) {
  if (!is.null(objname2)) {
    objname <- objname2
  }
  if (sum(x$ID == x$Description) >= 5) {
    x$ID <- paste0(objname, " / ", 1:nrow(x))
  }
  title = paste0("Parse form: ", objname)
  subtitle = paste0(
    "Split into ",
    ClusterNum,
    " Clusters. Generated by github@zhimingye/EnrichGT"
  )
  annotationString <- paste0(title, "   ", subtitle)
  df <- x
  # Merge ID col
  df$Description <- paste0(df$ID, " | ", df$Description)
  df <- df[, colnames(df) != "ID"]
  df$Cluster <- as.character(df$Cluster)
  # Pre Fix order, tinytable is more lazy, we must keep order!
  df$Cluster <- factor(
    df$Cluster,
    levels = fix_order(df$Cluster)[fix_order(df$Cluster) %in% df$Cluster]
  )
  df <- df |> dplyr::arrange(Cluster) # important!
  # make table tidy
  GROUP <- df$Cluster
  df <- df[, colnames(df) != "Cluster"]
  if (TYPE == "ORA") {
    daa <- tinytable::tt(
      df,
      width = c(.4, .1, .1, .1, .4),
      caption = annotationString
    ) |>
      tinytable::style_tt(fontsize = 0.8) |>
      tinytable::style_tt(
        i = 1:(nrow(df) + length(table(GROUP))),
        j = 3,
        background = map_color(
          df$PCT,
          GROUP,
          RColorBrewer::brewer.pal(8, "PuBuGn") |> rev()
        )
      ) |>
      tinytable::style_tt(
        i = 1:(nrow(df) + length(table(GROUP))),
        j = 4,
        background = map_color(
          df$Padj,
          GROUP,
          RColorBrewer::brewer.pal(8, "Spectral")
        )
      ) |>
      tinytable::style_tt(
        i = 1:(nrow(df) + length(table(GROUP))),
        j = 2,
        background = map_color(
          df$Count,
          GROUP,
          RColorBrewer::brewer.pal(8, "PiYG") |> rev()
        )
      ) |>
      tinytable::group_tt(i = GROUP)
  } else {
    df$Reg <- ifelse(df$Reg == "DownReg", "DN", "UP")
    daa <- tinytable::tt(
      df,
      width = c(.4, .075, .1, .1, .4),
      caption = annotationString
    ) |>
      tinytable::style_tt(fontsize = 0.8) |>
      tinytable::style_tt(
        i = 1:(nrow(df) + length(table(GROUP))),
        j = 3,
        background = map_color(
          df$absNES,
          GROUP,
          RColorBrewer::brewer.pal(8, "RdYlBu")
        )
      ) |>
      tinytable::style_tt(
        i = 1:(nrow(df) + length(table(GROUP))),
        j = 4,
        background = map_color(
          df$Padj,
          GROUP,
          RColorBrewer::brewer.pal(8, "Spectral")
        )
      ) |>
      tinytable::group_tt(i = GROUP)
  }

  daa -> y
  return(y)
}

fix_order <- function(x) {
  max_num <- max(gsub("Cluster_", "", x) |> as.numeric())
  return(paste0("Cluster_", 1:max_num))
}
batch_insert2 <- function(vec, inserts, positions) {
  ord <- order(positions)
  inserts <- inserts[ord]
  positions <- positions[ord]
  offset <- 0
  for (i in seq_along(inserts)) {
    pos <- positions[i] + offset
    vec <- append(vec, inserts[i], after = pos - 1)
    offset <- offset + 1
  }
  return(vec)
}
# group0 must be a sorted vec factor
map_color <- function(vec, group0, pal) {
  hulk_pal <- function(x) {
    (scales::col_numeric(pal, domain = NULL))(x)
  }
  col000 <- batch_insert2(
    vec = (vec |> hulk_pal()),
    inserts = rep("white", length(table(group0))),
    positions = cumsum(table(group0)) + 1
  )
  col000 <- c("white", col000)
  col000 <- col000[-length(col000)]
  col000
}
